name: ci

on:
  pull_request:
    branches:
      - '**'

concurrency:
  group: ci-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  id-token: write

jobs:
  lint_test:
    uses: babylonlabs-io/.github/.github/workflows/reusable_go_lint_test.yml@d2299e834fcbaca4bf2db043a2939798043d5951  # v0.16.1
    secrets: inherit
    with:
      go-version: '1.23'
      go-lint-version: 'v2.1.0'
      run-unit-tests: true
      run-integration-tests: false
      run-lint: true

  proto_lint:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run proto lint
        run: |
          make proto-lint

  docker_pipeline:
    permissions:
      contents: read         # Required by reusable workflow
      id-token: write        # Required for AWS OIDC
      security-events: write # Required for Trivy SARIF uploads
    uses: babylonlabs-io/.github/.github/workflows/reusable_docker_pipeline.yml@d2299e834fcbaca4bf2db043a2939798043d5951  # v0.16.1
    secrets: inherit
    with:
     publish: false
     dockerfile: ./contrib/images/babylond/Dockerfile
     repoName: babylond
     trivy_nofail: true

###############################################################################
###                                   E2E                                   ###
###############################################################################

  e2e-docker-build-babylon:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build docker babylond
        run: |
          make -C contrib/images babylond-e2e
      - name: Docker save babylon
        run: |
          docker save -o /tmp/docker-babylond.tar.gz babylonlabs-io/babylond:latest
      - name: Upload babylon artifact
        uses: actions/upload-artifact@v4
        with:
          name: babylond-${{ github.sha }} # so it renovates at every new sha
          path: /tmp/docker-babylond.tar.gz

  e2e-docker-build-e2e-init-chain:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build docker init-chain
        run: |
          make -C contrib/images e2e-init-chain
      - name: Docker save init-chain
        run: |
          docker save -o /tmp/docker-init-chain.tar.gz babylonlabs-io/babylond-e2e-init-chain:latest
      - name: Upload init-chain artifact
        uses: actions/upload-artifact@v4
        with:
          name: init-chain
          path: /tmp/docker-init-chain.tar.gz

  e2e-run-ibc-transfer:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestIBCTranferTestSuite
        run: |
          make test-e2e-cache-ibc-transfer

  e2e-run-btc-timestamping:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCTimestampingTestSuite
        run: |
          make test-e2e-cache-btc-timestamping

  e2e-run-btc-staking:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCStakingTestSuite
        run: |
          make test-e2e-cache-btc-staking

  e2e-run-gov-resume-finality:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestGovResumeFinality
        run: |
          make test-e2e-gov-resume-finality

  e2e-run-btc-rewards:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCRewardsDistribution
        run: |
          make test-e2e-cache-btc-rewards

  e2e-run-btc-staking-pre-approval:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCStakingPreApprovalTestSuite
        run: |
          make test-e2e-cache-btc-staking-pre-approval

  e2e-run-ica:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestICATestSuite
        run: |
          make test-e2e-cache-ica

  e2e-run-spam-prevention:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestEpochingSpamPreventionTestSuite
        run: |
          make test-e2e-cache-epoching-spam-prevention

  e2e-run-btc-stake-expansion:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCStakeExpansionTestSuite
        run: |
          make test-e2e-cache-btc-stake-expansion

  e2e-run-costaking:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestCostakingTestSuite
        run: |
          make test-e2e-cache-costaking

  e2e-run-validator-jailing:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestValidatorJailingTestSuite
        run: |
          make test-e2e-cache-validator-jailing

  e2e-V2:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2eV2
        run: |
          make test-e2ev2
