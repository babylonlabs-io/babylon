name: ci

on:
  pull_request:
    branches:
      - '**'

concurrency:
  group: ci-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint_test:
    uses: babylonlabs-io/.github/.github/workflows/reusable_go_lint_test.yml@92817762adb32ebbe832abfebe98efa09f7072e2  # v0.13.5
    secrets: inherit
    with:
      go-version: '1.23'
      go-lint-version: 'v2.1.0'
      run-unit-tests: true
      run-integration-tests: false
      run-lint: true
      testdata-url: "https://drive.usercontent.google.com/download?id=1PaZe96acfJqCHJrc24VAh77H-z0U9_x1&export=download&confirm=t"
      testdata-path: "app/upgrades/v3rc4/testdata/btc-delegations.json.test"

  proto_lint:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run proto lint
        run: |
          make proto-lint

  docker_pipeline:
    uses: babylonlabs-io/.github/.github/workflows/reusable_docker_pipeline.yml@5151754256060bf160c411d0784f831f29882106  # v0.13.4
    secrets: inherit
    with:
     publish: false
     dockerfile: ./contrib/images/babylond/Dockerfile
     repoName: babylond

###############################################################################
###                                   E2E                                   ###
###############################################################################

  e2e-docker-build-babylon:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build docker babylond
        run: |
          make -C contrib/images babylond-e2e
      - name: Docker save babylon
        run: |
          docker save -o /tmp/docker-babylond.tar.gz babylonlabs-io/babylond:latest
      - name: Upload babylon artifact
        uses: actions/upload-artifact@v4
        with:
          name: babylond-${{ github.sha }} # so it renovates at every new sha
          path: /tmp/docker-babylond.tar.gz

  e2e-docker-build-e2e-init-chain:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build docker init-chain
        run: |
          make -C contrib/images e2e-init-chain
      - name: Docker save init-chain
        run: |
          docker save -o /tmp/docker-init-chain.tar.gz babylonlabs-io/babylond-e2e-init-chain:latest
      - name: Upload init-chain artifact
        uses: actions/upload-artifact@v4
        with:
          name: init-chain
          path: /tmp/docker-init-chain.tar.gz

  e2e-run-ibc-transfer:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestIBCTranferTestSuite
        run: |
          make test-e2e-cache-ibc-transfer

  e2e-run-btc-timestamping:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCTimestampingTestSuite
        run: |
          make test-e2e-cache-btc-timestamping

  e2e-run-btc-staking:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCStakingTestSuite
        run: |
          make test-e2e-cache-btc-staking

  e2e-run-gov-resume-finality:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestGovResumeFinality
        run: |
          make test-e2e-gov-resume-finality

  e2e-run-btc-rewards:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCRewardsDistribution
        run: |
          make test-e2e-cache-btc-rewards

  e2e-run-btc-staking-pre-approval:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCStakingPreApprovalTestSuite
        run: |
          make test-e2e-cache-btc-staking-pre-approval

  e2e-run-ica:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestICATestSuite
        run: |
          make test-e2e-cache-ica

  e2e-run-spam-prevention:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestEpochingSpamPreventionTestSuite
        run: |
          make test-e2e-cache-epoching-spam-prevention

  e2e-run-upgrade-v4:
    needs: [e2e-docker-build-babylon, e2e-docker-build-e2e-init-chain]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Download init-chain artifact
        uses: actions/download-artifact@v4
        with:
          name: init-chain
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz

      - name: Docker load init chain
        run: |
          docker load < /tmp/docker-init-chain.tar.gz

      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestSoftwareUpgradeV23To4TestSuite
        run: |
          sudo make test-e2e-cache-upgrade-v4
      - name: Dump docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@v2

  e2e-run-btc-stake-expansion:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2e TestBTCStakeExpansionTestSuite
        run: |
          make test-e2e-cache-btc-stake-expansion

  e2e-V2:
    needs: [e2e-docker-build-babylon]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download babylon artifact
        uses: actions/download-artifact@v4
        with:
          name: babylond-${{ github.sha }}
          path: /tmp
      - name: Docker load babylond
        run: |
          docker load < /tmp/docker-babylond.tar.gz
      - name: Cache Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - name: Run e2eV2
        run: |
          make test-e2ev2
